@page
@model WebApplication2.Pages.AddObjectModel
@{
    ViewData["Title"] = "UAV";
}
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/osmtogeojson/osmtogeojson.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>

<h2>Step 1: Upload UAV Data & View Map</h2>

<!-- Upload JSON File -->
<h3>Upload UAV JSON File</h3>
<form enctype="multipart/form-data" method="post">
    <input type="file" name="JsonFile" accept=".json" />
    <button type="submit">Upload JSON</button>
</form>

@if (!ModelState.IsValid)
{
    <div style="color:red;">
        <ul>
            @foreach (var error in ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

@if (Model.UAVs != null && Model.UAVs.Any())
{
    <h3>UAV Data</h3>
    <table>
        <tr>
            <th>Id</th>
            <th>X</th>
            <th>Y</th>
            <th>Z</th>
        </tr>
        @foreach (var uav in Model.UAVs)
        {
            <tr>
                <td>@uav.Id</td>
                <td>@uav.X</td>
                <td>@uav.Y</td>
                <td>@uav.Z</td>
            </tr>
        }
    </table>
}

<h3>Upload and View OSM Map</h3>
<form enctype="multipart/form-data" id="osmUploadForm">
    <input type="file" id="osmFileInput" accept=".osm" />
</form>

<div id="map"></div>
<button id="saveMapButton">Save Map</button>

@if (!string.IsNullOrEmpty(Model.GeoJsonData))
{
    <div style="color:green; font-weight: bold;">Map saved successfully!</div>
}

<a asp-page="/ChooseStrategies">Next Step</a>

<script>
    // Initialize the map
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // Handle OSM file upload
    document.getElementById('osmFileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            alert('Please select a valid OSM file.');
            return;
        }

        const reader = new FileReader();
reader.onload = function (e) {
    const osmData = e.target.result;
    try {
        const geoJsonData = osmtogeojson(new DOMParser().parseFromString(osmData, 'text/xml'));
        if (!geoJsonData || !geoJsonData.features) {
            throw new Error('Invalid GeoJSON data.');
        }

        // Filter features to only include buildings
        const buildingFeatures = geoJsonData.features.filter(feature => 
            feature.properties && feature.properties.building // Check for 'building' tag
            && ['Polygon', 'MultiPolygon'].includes(feature.geometry.type) // Ensure valid geometry types
        );

        if (buildingFeatures.length === 0) {
            throw new Error('No buildings found in the OSM data.');
        }

        const geoJsonLayer = L.geoJSON(buildingFeatures, { style: { color: '#0078FF', weight: 2 } });

        geoJsonLayer.addTo(map);
        map.fitBounds(geoJsonLayer.getBounds());
    } catch (error) {
        console.error('Error processing OSM file:', error);
        alert('Invalid OSM file format or no buildings found.');
    }
};

        reader.readAsText(file);
    });

    // Save GeoJSON map data
    document.getElementById('saveMapButton').addEventListener('click', function () {
        map.eachLayer(function (layer) {
            if (layer instanceof L.GeoJSON) {
                const geoJsonData = layer.toGeoJSON();
                fetch('/AddObject?handler=SaveGeoJson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(geoJsonData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Map saved successfully!');
                    } else {
                        alert('Failed to save map.');
                    }
                })
                .catch(error => console.error('Error saving map:', error));
            }
        });
    });
</script>

